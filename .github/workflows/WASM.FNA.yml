name: WASM Build (FNA) â€” Single Threaded

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EMCC_CFLAGS: "-s USE_PTHREADS=0 -s PTHREAD_POOL_SIZE=0 -s OFFSCREENCANVAS_SUPPORT=0"
  EMCC_FORCE_STDLIBS: "1"

jobs:
  wasm:
    runs-on: ubuntu-latest
    name: WASM Release (no threads)

    steps:
      - name: Generate release name
        run: echo RELEASE_NAME=$(uuidgen) >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v4

      - uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.56

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ninja-build cmake llvm lld clang build-essential \
            python-is-python3 curl git libicu-dev pigz cpio

      - name: Verify emcc
        run: emcc -v

      # ---------------- SDL3 ----------------
      - name: SDL3 (single-threaded)
        run: |
          git clone -b release-3.2.26 https://github.com/libsdl-org/SDL
          cd SDL
          git apply SDL.patch
          mkdir build && cd build
          emcmake cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DSDL_TESTS=OFF \
            -DSDL_INSTALL_TESTS=OFF \
            -DSDL_PTHREADS=OFF \
            -DSDL_PTHREADS_SEM=OFF \
            -GNinja
          ninja

      # ---------------- SDL2 ----------------
      - name: SDL2 compat (single-threaded)
        run: |
          mkdir SDL2 && cd SDL2
          bash ../symbolrenamer.sh ../SDL/build/libSDL3.a ./SDL3.renamed.h

          git clone -b release-3.2.26 https://github.com/libsdl-org/SDL
          cd SDL
          git apply ../../SDL.patch
          git apply ../../SDL3-SDL2.patch
          mkdir build && cd build
          emcmake cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DSDL_TESTS=OFF \
            -DSDL_INSTALL_TESTS=OFF \
            -DSDL_PTHREADS=OFF \
            -DSDL_PTHREADS_SEM=OFF \
            -DCMAKE_C_FLAGS="-include ../SDL3.renamed.h" \
            -GNinja
          ninja

          cd ../..
          git clone -b release-2.32.58 https://github.com/libsdl-org/sdl2-compat
          cd sdl2-compat
          git apply ../SDL2.patch
          mkdir build && cd build
          emcmake cmake .. \
            -DSDL3_INCLUDE_DIRS=../../SDL/include \
            -DSDL3_STATIC_LIBRARY=../../SDL/build/libSDL3.a \
            -DSDL2COMPAT_STATIC=ON \
            -DSDL2COMPAT_TESTS=OFF \
            -DSDL2COMPAT_X11=OFF \
            -GNinja
          ninja

          cd ../..
          emcc -r -o SDL2.o \
            SDL/build/libSDL3.a \
            sdl2-compat/build/libSDL2-2.0.a \
            -s USE_PTHREADS=0
          ar cr SDL2.a SDL2.o

      # ---------------- FNA3D ----------------
      - name: FNA3D
        run: |
          git clone --recursive https://github.com/FNA-XNA/FNA3D -b 25.11
          cd FNA3D
          git apply ../FNA3D.patch
          mkdir build && cd build
          emcmake cmake .. \
            -DBUILD_SDL3=ON \
            -DSDL3_INCLUDE_DIRS=../../SDL/include \
            -DSDL3_LIBRARIES=../../SDL/build/libSDL3.a \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_C_FLAGS="-s USE_PTHREADS=0" \
            -GNinja
          ninja

      # ---------------- FAudio ----------------
      - name: FAudio
        run: |
          git clone https://github.com/FNA-XNA/FAudio -b 25.11
          cd FAudio
          mkdir build && cd build
          emcmake cmake .. \
            -DBUILD_SDL3=ON \
            -DSDL3_INCLUDE_DIRS=../../SDL/include \
            -DSDL3_LIBRARIES=../../SDL/build/libSDL3.a \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_C_FLAGS="-s USE_PTHREADS=0" \
            -GNinja
          ninja

      # ---------------- liba ----------------
      - name: liba
        run: |
          cd liba
          git clone -b v10.0.0 --depth=1 https://github.com/dotnet/runtime
          emcc liba.c -r -o liba.o \
            -s USE_PTHREADS=0 \
            -DHOST_BROWSER -DHOST_WASM -DTARGET_WASM \
            -Iruntime/src/mono -Iruntime/src/native
          emcc hot_reload_detour.c -r -o hot_reload_detour.o \
            -s USE_PTHREADS=0 \
            -DHOST_BROWSER -DHOST_WASM -DTARGET_WASM \
            -Iruntime/src/mono -Iruntime/src/native

      # ---------------- dotnet ----------------
      - name: dotnet runtime (NO THREADS)
        run: |
          cd liba/runtime
          git apply ../../dotnet.patch
          ./build.sh -os browser -s mono+libs \
            /p:WasmEnableThreads=false \
            -c Release
          7z a ../runtime.zip artifacts/bin/microsoft.netcore.app.runtime.browser-wasm/Release/*

      # ---------------- Package ----------------
      - name: Package binaries
        run: |
          mkdir Binaries
          cp liba/liba.o Binaries/
          cp liba/hot_reload_detour.o Binaries/
          cp liba/runtime.zip Binaries/dotnet.zip
          cp SDL/build/libSDL3.a Binaries/SDL3.a
          cp SDL2.a Binaries/SDL2.a
          cp FNA3D/build/libFNA3D.a Binaries/
          cp FNA3D/build/libmojoshader.a Binaries/
          cp FAudio/build/libFAudio.a Binaries/
          7z a FNA-WASM.Binaries.zip Binaries/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FNA-WASM-no-threads
          path: FNA-WASM.Binaries.zip

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          name: FNALibs WASM (no threads) ${{ env.RELEASE_NAME }}
          tag: ${{ env.RELEASE_NAME }}
          artifacts: FNA-WASM.Binaries.zip
          token: ${{ secrets.GITHUB_TOKEN }}
